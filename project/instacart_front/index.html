<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />
    <title>CS527 Team 5 ver1.1.5</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">CS527 Project 1 Team 5</a>
        <div class="container-fluid text-end">
          <img src="./image/alex.jpg"  alt="" width="30" height="30" class="d-inline-block align-text-top">
          <img src="./image/tom.jpg" alt="" width="30" height="30" class="d-inline-block align-text-top">
          <img src="./image/john.jpg" alt="" width="30" height="30" class="d-inline-block align-text-top">
          <img src="./image/need.jpg" alt="" width="30" height="30" class="d-inline-block align-text-top">
        </div>
      </div>
    </nav>

    <main class="container-fluid pt-5 mt-5">
      <div class="row">
        <div class="col-4">
          <div class="row">
            <div class="mb-3" style="max-height: 60vh; font-size: 0.8em;">
              <div id="carouselExampleIndicators" class="carousel carousel-dark slide" data-interval="false">
                <div class="carousel-inner">
                  <div class="carousel-item active">
                    <img src="./image/instacartDB.png" class="d-block" style="width: 80%;" alt="...">
                  </div>
                  <div class="carousel-item">
                    <img src="./image/adnimergeDB.png" class="d-block" style="width: 100%;" alt="...">
                  </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                  <span class="carousel-control-next-icon" aria-hidden="true"></span>
                  <span class="visually-hidden">Next</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="col-8">
          <div class="row">
            <div class="mb-3">
              <div class="row mb-2">
                <div class="col">
                  <label for="query_area" class="form-label fw-bold h4">Input query:</label>
                </div>
                <div class="col-8 text-left">
                  <div class="input-group mb-3">
                    <label class="input-group-text" for="inputGroupSelect01">Select Platform:</label>
                    <select id="platform" class="form-select" id="inputGroupSelect01">
                      <option value="mysql" selected>MySQL</option>
                      <option value="redshift">Redshift</option>
                      <option value="sqlserver">SQL Server</option>
                      <option value="mongodb">MongoDB</option>
                    </select>
                  </div>
                </div>
              </div>
              <textarea class="form-control" id="query_area" rows="5"></textarea>
            </div>
            <div class="row">
              <div class="col-4">
                <div class="input-group mb-3">
                  <label class="input-group-text" for="inputGroupSelect02">Select DB:</label>
                  <select id="database" class="form-select" id="inputGroupSelect02">
                    <option value="adnimerge" selected>adnimerge</option>
                    <option value="instacart">instacart</option>
                  </select>
                </div>
              </div>
              <div class="col-4 text-right">
                Elasped Time: <span class="mr-1 ml-1" id="elaspedTime"></span> s
              </div>
              <div class="col-4 text-right text-end">
                <button class="btn btn-secondary" id="clear_query">CLEAR</button>
                <button class="btn btn-success" id="execute_query" type="button">RUN</button>
              </div>
            </div>
            <div id="mongoHint" class="col-12 mb-1 mt-1" style="display: none;">
              <b>Notices for MongoDB:</b><br/>
              1. The DB <i>cs527</i> in MongoDB contains both <i>instacart</i> and <i>ADNIMERGE</i> collections(tables).<br/>
              2. SQLs for MongoDB are case-sensitive. <b>ALL</b> columns' name in <i>ADNIMERGE</i> collection are <b>UPPERCASE</b>.<br/>
            </div>
            <div class="col-12 mb-3 mt-5">
              <div class="row">
                <div class="col text-center">
              <span class="mr-1 ml-1 text-danger" id="errorMsg"></span>
                </div>
              </div>
              <div id="spinner" class="overlay" style="display: none;">
                <div class="d-flex justify-content-center">  
                  <div class="spinner-border text-secondary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
              <div class="overflow-auto" style="max-height: 60vh; font-size: 0.8em;">
                <table id="theTable" class="table table-primary table-striped">
                  <thead>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
      crossorigin="anonymous"
    ></script>
    <script>
      let curr_platform = 'mysql';

      $(() => {
        $("#clear_query").click(function(){
          $("#query_area").val('');
        });
        
        $('.carousel').carousel({
          interval: false,
        });

        // Indent in textarea
        $('#query_area').on('keydown', function(e) {
          if (e.keyCode == 9 || e.which == 9) {
            e.preventDefault();
            var s = this.selectionStart;
            $(this).val(function(i, v) {
              return v.substring(0, s) + "\t" + v.substring(this.selectionEnd)
            });
            this.selectionEnd = s + 1;
          }
        });

        // Check current platform version.
        $('#platform').change(function(){
          let selected_platform= $(this).val();
          if (selected_platform == 'mongodb') {
            curr_platform = 'mongodb';
            $('#database').empty();
            let placeholder = `<option value="cs527" selected>cs527</option>`;
            $('#database').append(placeholder);
            $('#mongoHint').css("display", "block");
          } else {
            $('#database').empty();
            curr_platform = 'mysql';
            let placeholder = `<option value="adnimerge" selected>adnimerge</option>
                               <option value="instacart">instacart</option>`;
            $('#database').append(placeholder);
            $('#mongoHint').css("display", "none");
          }
        });
      })

      $("#execute_query").click(function(){
        //Clean all data
        $("thead").empty();
        $("tbody").empty();
        $("#elaspedTime").empty();
        $("#errorMsg").empty();
        $("#spinner").css("display", "block");

        switch ($('#platform').val()) {
            case 'MySQL':
              $(`#theTable`).removeClass("table-success")
              $(`#theTable`).removeClass("table-dark")
              $(`#theTable`).removeClass("table-light")
              $(`#theTable`).addClass("table-primary")
              break
            case 'redshift':
              $(`#theTable`).removeClass("table-success")
              $(`#theTable`).removeClass("table-primary")
              $(`#theTable`).removeClass("table-light")
              $(`#theTable`).addClass("table-dark")
              break
            case 'sqlserver':
              $(`#theTable`).removeClass("table-success")
              $(`#theTable`).removeClass("table-dark")
              $(`#theTable`).removeClass("table-primary")
              $(`#theTable`).addClass("table-light")
              break
            case 'mongodb':
              $(`#theTable`).removeClass("table-dark")
              $(`#theTable`).removeClass("table-primary")
              $(`#theTable`).removeClass("table-light")
              $(`#theTable`).addClass("table-success")
              break
            default:

          }

        const database = $('#database').find(":selected").val();
        const platform = $('#platform').find(":selected").val();
        const query = $('#query_area').val();

        let data = {
          script: query,
          db: database
        }

        $.ajax
        ({
          type: "POST",
          // url: `http://axjour.tplinkdns.com/db/${platform}`,
          url: `http://ec2-3-131-198-17.us-east-2.compute.amazonaws.com:8081/db/${platform}`,
          // url: `http://localhost:8081/db/${platform}`,
          dataType: 'json',
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function (rtn){
            appendData(rtn);
            $("#spinner").css("display", "none");
          },
          error: (error) => {
            console.error(error);
            $(`#errorMsg`).text(error.responseText);
            $("#spinner").css("display", "none");
          }
        });

        const appendData = rtn => {

          const timeElasped = rtn.elapsed_time / 1000;
          $('#elaspedTime').text(timeElasped);
          
          const raw_data = rtn.rawData;

          if (curr_platform == 'mongodb') {
            raw_data.forEach(row => {
              let placeholder = `<tr>`;
              for (const prop in row) {
                placeholder = placeholder + `<td>${prop}: ${row[prop]}</td>`
              }
              placeholder = placeholder + `</tr>`
              $('tbody').append(placeholder)
            });
          } else {
            const col_name = rtn.colName;

            let title_placeholder = `<tr>`
            col_name.forEach(col => {
              title_placeholder = title_placeholder + `<td>${col}</td>`
            });
            title_placeholder = title_placeholder + `</tr>`
            $('thead').append(title_placeholder)

            
            raw_data.forEach(row => {
              let placeholder = `<tr>`
              row.forEach(i => {
                placeholder = placeholder + `<td>${i}</td>`
              })
              placeholder = placeholder + `</tr>`
              $('tbody').append(placeholder)
            });

          }
        }

      });
		</script>
  	</body>
</html>
